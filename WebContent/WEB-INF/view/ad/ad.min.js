Do.add("constant", {path: "/proxy/www/js/global/constant.js", type: "js"});
var gardenId;
var material_img = new Image();
var defaultImage = "/images/image200.jpg";
var Ad = {data: {url: "", uploader_url: $("#hidden-uploader-url").val()}, init: function () {
    $("#ad-sub-menu").tabs({border: false, href: "/ad/desc.jsp", onSelect: function (a) {
    }});
    Do("jquery-plugin", function () {
        gardenId = $.getUrlParam("gid")
    });
    this.initEvent();
    this.customValidate();
    this.initUploadify()
}, initEvent: function () {
    var a = this;
    $("#add_client_btn").click(function () {
        a.addClientWithAddMaterials()
    });
    $("#select_client_btn").click(function () {
        a.selectClient()
    });
    $("#search_client").click(function () {
        a.searchClient()
    });
    $("#reset_search_key").click(function () {
        $("#contact_key").val("");
        $("#company_key").val("");
        a.searchClient()
    });
    $("#select_client_ok").click(function () {
        a.selectClientOk()
    });
    $("#select_client_list").datagrid({onDblClickCell: function (b, d, c) {
        a.selectClientOk()
    }});
    $("#select_materials_btn").click(function () {
        a.selectMaterials()
    });
    $("#edit_schedule_materials").focus(function () {
        a.selectMaterials()
    });
    $("#add_materials_btn").click(function () {
        a.addMaterialsWithAddSchedule()
    });
    $("#search_materials").click(function () {
        a.searchMaterials()
    });
    $("#reset_search_materials_key").click(function () {
        $("#name_key").val("");
        $("#materials_contact_key").val("");
        $("#materials_company_key").val("");
        a.searchMaterials()
    });
    $("#select_materials_ok").click(function () {
        a.selectMaterialsOk()
    });
    $("#select_materials_list").datagrid({onDblClickCell: function (b, d, c) {
        if (d === "URL") {
            window.open(c, "_blank")
        } else {
            if (d === "ADDRESS") {
                var e = $("#select_materials_list").datagrid("getSelected");
                $("#img_preview").attr("src", c).attr("width", e.WIDTH).attr("height", e.HEIGHT);
                $("#materials_img_preview").dialog("open").dialog("setTitle", "物料图片预览")
            } else {
                a.selectMaterialsOk()
            }
        }
    }})
}, customValidate: function () {
    Do("constant", function () {
        $.extend($.fn.validatebox.defaults.rules, {startdateIsValid: {validator: function (f, g) {
            var c = false;
            var d = new Date();
            var e = f.split("-");
            var b = new Date(e[0], e[1] - 1, e[2]);
            if (b <= d && (b.toLocaleDateString() !== d.toLocaleDateString())) {
                if ($("#edit_schedule_id").val().length !== 0) {
                    c = true
                } else {
                    $.messager.show({title: "提示", msg: "开始时间必须在当前时间之后！"})
                }
            } else {
                var h = $("#edit_schedule_id").val();
                var a = $(g[0]).combo("getValue");
                $.ajax({async: false, type: "post", url: "/proxy/api/ad/startdateIsValid", data: {id: h, targetId: gardenId, position: a, startdate: f}, success: function (i) {
                    c = i
                }})
            }
            return c
        }, message: "开始时间已有广告安排！"}, scheduleIsValid: {validator: function (h, c) {
            var a = $("#edit_schedule_id").val();
            var e = $(c[0]).combo("getValue");
            var i = $(c[1]).combo("getValue");
            var j = false;
            if (i) {
                var d = i.split("-");
                var g = h.split("-");
                var b = new Date(d[0], d[1] - 1, d[2]);
                var f = new Date(g[0], g[1] - 1, g[2]);
                if (b <= f) {
                    $.ajax({async: false, type: "post", url: "/proxy/api/ad/scheduleIsValid", data: {id: a, targetId: gardenId, position: e, startdate: i, enddate: h}, success: function (k) {
                        j = k
                    }})
                } else {
                    $.messager.show({title: "提示", msg: "结束时间必须在开始时间之前！"})
                }
            } else {
                $.messager.show({title: "提示", msg: "请选择开始时间！"})
            }
            return j
        }, message: "广告时间安排与已安排的广告日程有冲突！"}, phoneNo: {validator: function (a, b) {
            return(constant.regex.mobile.test(a) || constant.regex.phone.test(a))
        }, message: "请输入正确的联系电话，如有区号请使用“-”隔开！"}, materialImgNameIsValid: {validator: function (c, d) {
            var b = false;
            var e = $(d[0]).val();
            var a = $(d[1]).val();
            if (a.length === 0) {
                $.messager.show({title: "提示", msg: "请选择广告物料所属客户！"})
            } else {
                $.ajax({async: false, type: "post", url: "/proxy/api/ad/materialImgNameIsValid", data: {id: e, clientId: a, name: c}, success: function (f) {
                    b = f
                }})
            }
            return b
        }, message: "该客户下已有同名的物料，请使用另外的名称！"}})
    })
}, initUploadify: function () {
    var a = this;
    Do("uploadify", function () {
        $("#uploadify").uploadify({swf: "/proxy/www/widget/uploadify-3.2/uploadify.swf", uploader: a.data.uploader_url, buttonImage: "/proxy/www/widget/uploadify-3.2/upload.png", fileObjName: "Filedata", queueID: "fileQueue", queueSizeLimit: 5, auto: true, multi: false, height: 28, width: 78, fileSizeLimit: "0", fileTypeExts: "*.png;*.gif;*.jpg;*.bmp;*.jpeg", fileTypeDesc: "图片文件(*.png;*.gif;*.jpg;*.bmp;*.jpeg)", formData: {type: "image"}, onInit: function () {
        }, onUploadSuccess: function (d, e, c) {
            $("#materials_img").attr("src", e + "?890");
            var b = e.substr(e.lastIndexOf("/upload/"));
            $("#new_materials_img").val(b);
            material_img.src = e;
            $("#new_materials_type").val(e.substr(e.lastIndexOf(".") + 1))
        }})
    })
}, addClientWithAddMaterials: function () {
    var a = this;
    $("#new_client").dialog("open").dialog("setTitle", "添加广告客户");
    $("#new_client_fm").form("clear");
    a.data.url = "/proxy/api/ad/addClient";
    $("#client_info_submit").unbind("click").click(function () {
        a.submitClientWithAddMaterials()
    })
}, submitClientWithAddMaterials: function () {
    var _this = this;
    var new_client_contact = $("#new_client_contact").val();
    var new_client_company = $("#new_client_company").val();
    Do("constant", function () {
        $("#new_client_fm").form("submit", {url: _this.data.url, onSubmit: function () {
            return $(this).form("validate")
        }, success: function (json) {
            json = eval("(" + json + ")");
            if (json.result === constant.SYSCODE.SUCCESS) {
                $("#new_client").dialog("close");
                $("#new_materials_clientid").val(json.msg);
                $("#new_materials_client").val(new_client_company + "  " + new_client_contact).validatebox("validate");
                $("#new_materials_name").validatebox("validate");
                _this.data.url = "/proxy/api/ad/addMaterialImg"
            } else {
                $.messager.show({title: "保存结果", msg: constant.messages.save_fail})
            }
        }})
    })
}, selectClient: function () {
    $("#select_client_dialog").dialog("open").dialog("setTitle", "选择客户");
    $("#select_client_list").datagrid("reload")
}, searchClient: function () {
    var b = $.trim($("#contact_key").val());
    var c = $.trim($("#company_key").val());
    var a = "/proxy/api/ad/searchClients";
    $("#select_client_list").datagrid({queryParams: {contactKey: b, companyKey: c}, url: a})
}, selectClientOk: function () {
    var a = $("#select_client_list").datagrid("getSelected");
    if (a) {
        $("#new_materials_clientid").val(a.ID);
        $("#new_materials_client").val(a.COMPANY + "  " + a.CONTACT).validatebox("validate");
        $("#new_materials_name").validatebox("validate");
        $("#select_client_dialog").dialog("close")
    }
}, selectMaterials: function () {
    $("#select_materials_dialog").dialog("open").dialog("setTitle", "选择广告物料");
    $("#select_materials_list").datagrid("reload")
}, searchMaterials: function () {
    var c = $.trim($("#name_key").val());
    var b = $.trim($("#materials_contact_key").val());
    var d = $.trim($("#materials_company_key").val());
    var a = "/proxy/api/ad/searchMaterialsImg";
    $("#select_materials_list").datagrid({queryParams: {nameKey: c, contactKey: b, companyKey: d}, url: a})
}, selectMaterialsOk: function () {
    var a = $("#select_materials_list").datagrid("getSelected");
    if (a) {
        $("#edit_schedule_materials").val(a.NAME).validatebox("validate");
        $("#edit_schedule_materialId").val(a.ID);
        $("#select_materials_dialog").dialog("close")
    }
}, addMaterialsWithAddSchedule: function () {
    var a = this;
    $("#new_materials_client").unbind("focus").focus(function () {
        a.selectClient()
    });
    $("#new_materials").dialog("open").dialog("setTitle", "添加广告物料");
    $("#new_materials_fm").form("clear");
    a.data.url = "/proxy/api/ad/addMaterialImg";
    $("#materials_img").attr("src", defaultImage);
    $("#select_clent_div").show();
    $("#materials_img_submit").unbind("click").click(function () {
        a.submitMaterialsWithAddSchedule()
    })
}, submitMaterialsWithAddSchedule: function () {
    var _this = this;
    Do("constant", function () {
        var materials_form = $("#new_materials_fm");
        $("#new_materials_height").val(material_img.height);
        $("#new_materials_width").val(material_img.width);
        var materialsImg = $("#materials_img");
        if (materialsImg.attr("src") === defaultImage) {
            $.messager.show({title: "提示", msg: "请上传物料图片！"})
        } else {
            if ($("#new_materials_clientid").val() === "") {
                $.messager.show({title: "提示", msg: "请选择所属客户！"})
            } else {
                var materials_name = $("#new_materials_name").val();
                materials_form.form("submit", {url: _this.data.url, onSubmit: function () {
                    return $(this).form("validate")
                }, success: function (json) {
                    json = eval("(" + json + ")");
                    if (json.result === constant.SYSCODE.SUCCESS) {
                        $("#new_materials").dialog("close");
                        materialsImg.attr("src", defaultImage);
                        $("#edit_schedule_materials").val(materials_name).validatebox("validate");
                        $("#edit_schedule_materialId").val(json.msg);
                        _this.data.url = "/proxy/api/ad/addGardenAdSchedule"
                    } else {
                        $.messager.show({title: "保存结果", msg: constant.messages.save_fail})
                    }
                }})
            }
        }
    })
}};
$(function () {
    Ad.init()
});